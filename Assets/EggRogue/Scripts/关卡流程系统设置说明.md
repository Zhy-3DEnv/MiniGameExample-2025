# 关卡流程系统设置说明

## 一、系统概述

实现了完整的关卡流程：
1. **关卡计时器**：30秒倒计时（可配置）
2. **胜利判断**：时间到且玩家存活 = 胜利
3. **结算界面**：显示拾取金币 + 胜利奖励，2秒后自动进入卡片选择
4. **卡片选择**：显示4张卡片，玩家选择后应用属性加成并进入下一关

---

## 二、已创建的系统

### 1. LevelTimer（关卡计时器）
- **位置**：`Assets/EggRogue/Scripts/Game/LevelTimer.cs`
- **功能**：倒计时、胜利/失败判断
- **使用**：挂在 GameScene 的空物体上

### 2. CardData / CardDatabase（卡片系统）
- **位置**：`Assets/EggRogue/Scripts/Cards/CardData.cs`、`CardDatabase.cs`
- **功能**：卡片配置（ScriptableObject）
- **菜单**：`EggRogue → 创建 CardDatabase 与默认卡片`

### 3. CardManager（卡片管理器）
- **位置**：`Assets/EggRogue/Scripts/Cards/CardManager.cs`
- **功能**：管理已选卡片，应用属性加成
- **常驻**：PersistentScene

### 4. ResultPanel（结算界面）
- **位置**：`Assets/EggRogue/Scripts/UI/ResultPanel.cs`
- **功能**：显示拾取金币、胜利奖励，2秒倒计时后进入卡片选择

### 5. CardSelectionPanel（卡片选择界面）
- **位置**：`Assets/EggRogue/Scripts/UI/CardSelectionPanel.cs`
- **功能**：显示4张卡片供玩家选择

### 6. LevelFlowManager（关卡流程管理器）
- **位置**：`Assets/EggRogue/Scripts/Game/LevelFlowManager.cs`
- **功能**：连接计时器、结算、卡片选择等流程

---

## 三、设置步骤

### 步骤 1：创建 CardDatabase 与卡片

1. 菜单：**EggRogue → 创建 CardDatabase 与默认卡片**
2. 会在 `Assets/EggRogue/Configs/Cards/` 下生成 8 张默认卡片
3. 按需在 Inspector 中调整卡片属性

### 步骤 2：在 GameScene 中添加 LevelTimer

1. 打开 **GameScene**
2. 创建空物体，命名为 **LevelTimer**
3. 添加组件：**LevelTimer**
4. 勾选 **Auto Start**（自动开始计时）

### 步骤 3：在 GameScene 中添加 LevelFlowManager

1. 在 **GameScene** 中创建空物体，命名为 **LevelFlowManager**
2. 添加组件：**LevelFlowManager**
3. 将 **LevelTimer** 拖到 **Level Timer** 字段（或留空，会自动查找）

### 步骤 4：在 PersistentScene 中添加 ResultPanel

1. 打开 **PersistentScene**
2. 在 **UIRoot/Canvas** 下创建 **Panel**，命名为 **ResultPanel**
3. 添加组件：**ResultPanel**
4. 在 Panel 下创建 UI 元素：
   - **Text**：`CollectedGoldText`（拾取金币文本）
   - **Text**：`VictoryRewardText`（胜利奖励文本）
   - **Text**：`TotalGoldText`（总金币文本）
   - **Text**：`CountdownText`（倒计时文本，例如："2秒后进入卡片选择..."）
5. 在 **ResultPanel** 组件上绑定这些 Text 引用

### 步骤 5：在 PersistentScene 中添加 CardSelectionPanel

1. 在 **UIRoot/Canvas** 下创建 **Panel**，命名为 **CardSelectionPanel**
2. 添加组件：**CardSelectionPanel**
3. 在 Panel 下创建 **4 个 Button**（例如：`CardButton1`、`CardButton2`、`CardButton3`、`CardButton4`）
4. 每个 Button 下创建：
   - **Image**：`Icon`（卡片图标，可选）
   - **Text**：`Name`（卡片名称）
   - **Text**：`Description`（卡片描述）
5. 在 **CardSelectionPanel** 组件上：
   - 将 4 个 Button 拖到 **Card Buttons** 数组
   - 将 `Configs/CardDatabase` 拖到 **Card Database** 字段

### 步骤 6：更新 UIManager 引用

1. 打开 **PersistentScene**
2. 选中 **Managers/UIManager**
3. 在 Inspector 中：
   - 将 **ResultPanel** 拖到 **Result Panel** 字段
   - 将 **CardSelectionPanel** 拖到 **Card Selection Panel** 字段

### 步骤 7：更新 GameHudPanel 显示倒计时

1. 在 **PersistentScene** 的 **GameHudPanel** 下创建 **Text**，命名为 `TimerText`
2. 选中 **GameHudPanel** 组件，将 `TimerText` 拖到 **Timer Text** 字段
3. 倒计时会自动显示为 `MM:SS` 格式

### 步骤 8：确保 LevelData 配置正确

1. 打开 `Assets/EggRogue/Configs/Levels/Level_01.asset`
2. 确认 **Level Duration** = 30（第一关30秒）
3. 确认 **Victory Reward Gold** = 50（胜利奖励金币数）
4. 其他关卡可按需调整

---

## 四、完整流程

```
游戏开始
  ↓
进入 GameScene（关卡1）
  ↓
LevelTimer 开始倒计时（30秒）
GameHudPanel 显示倒计时
  ↓
[玩家战斗，拾取金币]
  ↓
时间到且玩家存活
  ↓
LevelTimer.OnLevelVictory 触发
  ↓
LevelFlowManager.OnLevelVictory
  ↓
ResultPanel.ShowResult(拾取金币, 胜利奖励)
  ↓
显示结算界面 2 秒
  ↓
ResultPanel 倒计时结束
  ↓
UIManager.ShowCardSelection()
  ↓
CardSelectionPanel 显示 4 张卡片
  ↓
玩家选择卡片
  ↓
CardManager.ApplyCard(selectedCard)
  ↓
应用属性加成
  ↓
LevelManager.NextLevel()
  ↓
加载下一关（关卡2）
  ↓
重复流程...
```

---

## 五、卡片属性加成说明

卡片可以加成以下属性：
- **damageBonus**：伤害 +N
- **fireRateBonus**：攻击速度 +N（发/秒）
- **maxHealthBonus**：最大生命值 +N
- **moveSpeedBonus**：移动速度 +N
- **bulletSpeedBonus**：子弹速度 +N
- **attackRangeBonus**：攻击范围 +N

**注意**：卡片加成是**累加**的，选择多张卡片会叠加效果。

---

## 六、常见问题

1. **倒计时不显示？**
   - 确认 **GameHudPanel** 的 **Timer Text** 已绑定
   - 确认 **LevelTimer** 已添加到 GameScene 且 **Auto Start** 已勾选

2. **时间到了没有触发胜利？**
   - 确认玩家有 **Health** 组件且未死亡
   - 确认 **LevelFlowManager** 已添加到 GameScene
   - 检查 Console 是否有错误日志

3. **结算界面不显示？**
   - 确认 **ResultPanel** 在 PersistentScene 的 Canvas 下
   - 确认 **UIManager** 的 **Result Panel** 引用已绑定
   - 确认 **LevelFlowManager** 能找到 **ResultPanel**

4. **卡片选择界面不显示？**
   - 确认 **CardSelectionPanel** 在 PersistentScene 的 Canvas 下
   - 确认 **UIManager** 的 **Card Selection Panel** 引用已绑定
   - 确认 **CardSelectionPanel** 的 **Card Database** 已指定

5. **卡片加成没生效？**
   - 确认 **CardManager** 在 PersistentScene 的 Managers 下
   - 确认玩家有 **PlayerCombatController**、**Health**、**CharacterController** 组件
   - 检查 Console 是否有应用卡片的日志

---

## 七、后续扩展建议

1. **卡片图标**：为 CardData 添加 Sprite 图标，在 CardSelectionPanel 中显示
2. **卡片稀有度**：添加稀有度系统（普通/稀有/史诗）
3. **卡片效果**：扩展卡片效果（例如：穿透、分裂、爆炸等）
4. **失败界面**：玩家死亡时显示失败界面，提供重试选项
5. **关卡进度保存**：保存玩家已选卡片，重新开始游戏时恢复

---

完成以上设置后，即可体验完整的关卡流程：计时 → 胜利 → 结算 → 卡片选择 → 下一关！
