# 武器与商店系统设计方案

> 本文档梳理武器系统、商店系统、道具系统的功能需求、逻辑流程及实现方案，供后续开发参考。

---

## 一、功能需求总览

| 模块 | 核心需求 | 优先级 |
|------|----------|--------|
| **多武器槽** | 角色最多 6 个武器槽，每把武器独立自动攻击 | P0 |
| **武器选择界面** | 选角后先选武器，再进入游戏；默认提供枪+刀 | P0 |
| **武器类型** | 远程（枪）与近战（刀），近战距离近、伤害高 | P0 |
| **初始携带数量** | 首次进入游戏可携带 x 把武器（默认 x=1） | P0 |
| **商店系统** | 关卡结束后进入商店，用金币购买武器和道具 | P0 |
| **武器等级** | 1-5 级，2 把同级武器合成 1 把高一级 | P1 |
| **道具系统** | 道具栏、道具效果（如电塔：范围内闪电攻击） | P1 |

---

## 二、流程与状态

### 2.1 游戏主流程（修改后）

```
主菜单
  → 角色选择
  → 【新增】武器选择（仅首次进入游戏，默认 1 枪 + 1 刀，选 1 把作为起始武器）
  → 进入游戏（第 1 关）
  → 关卡胜利
  → 结算界面（ResultPanel）
  → 选卡界面（CardSelectionPanel，选 1 张属性卡）
  → 【新增】商店界面（每关必进，可不购买直接继续）
  → 进入下一关
  → 循环...（武器选择界面不再出现）
```

### 2.2 关键节点

| 节点 | 当前行为 | 目标行为 |
|------|----------|----------|
| 角色选择 → 游戏 | 直接进入 GameScene | 先进入武器选择界面 |
| 武器选择 → 游戏 | - | 选定 x 把武器后进入游戏 |
| 选卡 → 下一关 | 选完卡直接 NextLevel | 先进入商店，买完再 NextLevel |
| 游戏中攻击 | 单一 PlayerCombatController | 多武器各自独立攻击 |

---

## 三、武器系统设计

### 3.1 数据结构

#### WeaponData（ScriptableObject）

| 字段 | 类型 | 说明 |
|------|------|------|
| weaponId | string | 唯一标识，如 "gun_lv1", "knife_lv1" |
| weaponName | string | 显示名称 |
| weaponType | enum | Ranged / Melee |
| level | int | 1-5 |
| damage | float | 单次伤害 |
| fireRate | float | 攻击频率（次/秒） |
| attackRange | float | 攻击范围 |
| bulletSpeed | float | 子弹速度（远程有效） |
| bulletPrefab | GameObject | 子弹预制体（远程） |
| meleeHitPrefab | GameObject | 近战挥砍/判定预制体（近战） |
| modelPrefab | GameObject | 武器模型预制体（按等级不同） |
| nextLevelWeapon | WeaponData | 合成后的下一级武器（2 把 lv1 → 1 把 lv2） |

#### WeaponSlot（运行时）

- 槽位索引 0-5
- 当前装备的 WeaponData
- 对应挂载点、攻击逻辑实例

### 3.2 武器类型与行为

| 类型 | 攻击方式 | 范围 | 伤害特点 |
|------|----------|------|----------|
| **Ranged（枪）** | 发射子弹，自动瞄准 | 大（如 10m） | 中等伤害 |
| **Melee（刀）** | 近战挥砍（需挥砍动画，动作很快）| 小（如 2m） | 高伤害 |

### 3.3 武器等级与合成

- 等级 1-5，每级对应不同模型预制体
- 合成规则：2 把同 ID 同级武器 → 1 把下一级武器
- 示例：2×枪_lv1 → 1×枪_lv2；2×刀_lv1 → 1×刀_lv2
- **合成仅在商店中触发**，武器选择界面与游戏中均不可合成

### 3.4 多武器攻击逻辑

- **方案 A**：一个 `WeaponController` 管理 6 个 `WeaponInstance`，每个独立冷却、独立寻敌、独立攻击
- **方案 B**：6 个挂载点，每点一个 `WeaponBehaviour` 组件，各自 Update 中处理攻击
- **推荐**：方案 A，集中管理，便于与 CharacterStats、卡牌加成等联动

### 3.5 武器挂载与模型

- Player 预制体已有 `WeaponSlot` 空节点（可扩展为 6 个子节点：WeaponSlot_0 ~ WeaponSlot_5）
- 每把武器的 modelPrefab 实例化到对应 WeaponSlot 下
- 武器模型可绑定 firePoint（枪口）或 meleePoint（挥砍起点）

---

## 四、武器选择界面设计

### 4.1 界面结构

- 标题：「选择武器」
- 可选武器池：默认 1 把枪 + 1 把刀（可配置）
- 玩家选择 **1 把** 作为起始武器
- 确认按钮：选定 1 把后进入游戏
- **重要**：此界面**仅在首次进入游戏时显示一次**，通关/重开后不再出现

### 4.2 数据流

- `WeaponSelectionManager`：常驻，存储起始武器（首次选角时写入）
- PlayerSpawner / WeaponController 根据 `WeaponSelectionManager` 初始化武器槽
- 后续武器通过商店购买获得

### 4.3 查看当前武器

- **角色信息面板**（原「属性面板」AttributePanel 更名）：展示当前携带的武器列表及属性

---

## 五、商店系统设计

### 5.1 触发时机

- 选卡界面完成后，**每关必定进入商店**（不可跳过进入）
- 流程：ResultPanel → CardSelectionPanel（选 1 张卡）→ **ShopPanel**（必进）→ 点击「继续」→ NextLevel
- 玩家**可以不购买任何商品**，直接点击「继续」进入下一关

### 5.2 商店内容

- 默认随机刷出 **5 个商品**（武器 + 道具混合）
- 每个商品有价格（金币）

### 5.3 随机刷新（Reroll）

- 「随机」按钮：花费金币重新随机 5 个商品
- **同一次商店内**：每次点击随机，价格递增（如 10 → 20 → 30 → ...）
- **进入下一关的商店**：随机价格**重置**为初始值

### 5.4 商品数据结构

#### ShopItemData（或复用）

| 字段 | 说明 |
|------|------|
| itemType | Weapon / Item |
| weaponData | WeaponData（武器时） |
| itemData | ItemData（道具时） |
| basePrice | int 基础售价（用于出售折算） |
| 稀有度/权重 | 用于随机刷出 |

### 5.5 购买与替换逻辑

- **购买武器**：有空格则放入；**槽位满时允许替换**
  - 替换流程：出售当前槽位武器（**售价 = 基础价格 × 80%**）→ 获得金币 → 购买新武器放入该槽
- **购买道具**：放入物品栏（默认 50 格）
- 道具栏满时：可提示或限制购买

---

## 六、道具系统设计

### 6.1 物品栏

- 独立于武器槽，用于存放道具
- **默认 50 格**，后续可拓展
- 道具需在战斗中「生效」，如电塔围绕角色、定时对范围内敌人造成伤害

### 6.2 道具数据结构 ItemData

| 字段 | 类型 | 说明 |
|------|------|------|
| itemId | string | 唯一标识 |
| itemName | string | 显示名称 |
| description | string | 描述 |
| icon | Sprite | 图标 |
| effectType | enum | LightningTower / 其他... |
| prefab | GameObject | 战斗中的表现预制体（如电塔模型+逻辑） |
| 效果参数 | 视 effectType | 如：范围、伤害、间隔 |

### 6.3 道具效果实现方式

- 每个 effectType 对应一个 `ItemEffectBehaviour` 脚本
- 例：电塔（LightningTower）
  - 在玩家周围生成电塔实例（或挂载在玩家下）
  - 每 xx 秒对 xx 范围内敌人造成伤害
  - 可由 `ItemEffectManager` 统一管理，根据物品栏中道具类型创建对应 Behaviour

### 6.4 道具与战斗的绑定

- `ItemInventoryManager`：常驻，存储当前持有的道具列表
- 进入战斗时：`ItemEffectManager` 读取物品栏，为每个道具创建效果实例
- 离开战斗 / 下一关：效果实例可保留或按规则重置

---

## 七、与现有系统的关系

### 7.1 需修改的现有模块

| 模块 | 修改点 |
|------|--------|
| **CharacterSelectionPanel** | 「开始游戏」→ 打开武器选择界面（仅首次） |
| **CardSelectionPanel** | 选卡+确认后 → 打开商店（每关必进） |
| **AttributePanel** | 更名为「角色信息面板」，展示当前武器与属性 |
| **PlayerCombatController** | 重构为支持多武器，或拆分为 WeaponController + 多 WeaponInstance |
| **PlayerSpawner** | 根据 WeaponSelectionManager 初始化武器槽 |
| **UIManager** | 增加武器选择界面、商店界面的 Show/Hide |

### 7.2 新增常驻管理器

| 管理器 | 职责 |
|--------|------|
| WeaponSelectionManager | 存储本轮选中的武器，供进入游戏时使用 |
| WeaponInventoryManager | 运行时武器槽状态（6 槽）、合成逻辑 |
| ItemInventoryManager | 运行时道具栏状态 |
| ShopManager | 商店刷新、购买、出售（80%）、随机重刷（递增价格，下关重置） |

### 7.3 与 CardManager 的关系

- 现有卡片：属性加成（伤害、射速等），继续保留
- 武器：独立槽位，单独攻击逻辑，可与卡片加成叠加（如卡片加伤害，武器基础伤害×加成）
- 道具：独立物品栏，独立效果系统

---

## 八、实现阶段建议

### Phase 1：基础多武器 + 武器选择

1. 定义 WeaponData、WeaponDatabase
2. 实现 WeaponController（管理多槽、多武器攻击）
3. 实现 WeaponSelectionPanel、WeaponSelectionManager
4. 修改流程：选角 → 选武器 → 进入游戏
5. 默认提供 1 枪 + 1 刀，初始携带数 x=1

### Phase 2：商店 + 道具栏骨架

1. 实现 ShopPanel、ShopManager
2. 流程：选卡 → 商店 → 下一关
3. 定义 ItemData、ItemInventoryManager、物品栏 UI 骨架
4. 商店可购买武器（放入武器槽）、道具（放入物品栏）

### Phase 3：武器等级与合成

1. WeaponData 增加 level、nextLevelWeapon、basePrice（出售用）
2. 每级对应不同 modelPrefab
3. **仅在商店**实现合成逻辑（2 合 1）及合成 UI

### Phase 4：道具效果

1. 定义 ItemEffectBehaviour 基类
2. 实现电塔等具体效果
3. ItemEffectManager 根据物品栏在战斗中创建效果

---

## 九、已确认项（v2 更新）

| 项 | 确认结果 |
|----|----------|
| **商店进入** | 每关必进，可不购买直接点「继续」 |
| **商店商品** | 默认 5 个随机（武器+道具） |
| **随机按钮** | 花费金币重随机，同次商店内每次价格递增，下关重置 |
| **武器槽满时** | 允许替换：出售当前武器（80% 基础价）后购买新武器 |
| **道具栏容量** | 默认 50 格 |
| **合成时机** | 仅在商店触发 |
| **武器选择界面** | 仅首次进入游戏显示，选 1 把起始武器，之后不再出现 |
| **属性面板** | 更名为「角色信息面板」，展示当前武器 |
| **近战表现** | 需挥砍动画，动作很快 |

---

*文档版本：v2 | 已纳入确认项*
