# 虚拟摇杆设置指南

## 一、UI 结构

摇杆应该放在 **PersistentScene 的 Canvas 下**（因为它是常驻 UI，不会随关卡切换而消失）。

### 推荐层级结构：

```
Canvas (PersistentScene)
  └─ GameHudPanel (GameHudPanel 组件)
      └─ JoystickPanel (VirtualJoystick 组件)
          ├─ Background (Image - 摇杆背景圆圈)
          └─ Handle (Image - 摇杆手柄圆圈)
```

或者，如果摇杆是独立的（不在 GameHudPanel 下）：

```
Canvas (PersistentScene)
  ├─ GameHudPanel
  └─ JoystickPanel (VirtualJoystick 组件)
      ├─ Background (Image)
      └─ Handle (Image)
```

---

## 二、创建摇杆 UI（在 Unity 编辑器中）

### 步骤 1：创建 JoystickPanel

1. 在 **PersistentScene** 的 Canvas 下，右键 → UI → Panel，命名为 `JoystickPanel`
2. 调整位置：建议放在**左下角**（移动端常用位置）
   - 设置 Anchor：左下角（Bottom-Left）
   - 设置 Pivot：(0, 0)
   - 设置 Position：例如 (100, 100)（距离左下角 100 像素）
   - 设置 Size：例如 (200, 200)（摇杆区域大小）

### 步骤 2：创建 Background（背景圆圈）

1. 在 `JoystickPanel` 下，右键 → UI → Image，命名为 `Background`
2. 设置 Image：
   - **Source Image**：可以留空（会显示为白色方块），或者拖入一个圆形 Sprite
   - **Color**：半透明灰色，例如 `(128, 128, 128, 150)`
3. 设置 RectTransform：
   - **Anchor Presets**：按住 Alt + Shift，点击 `Stretch-Stretch`（铺满父节点）
   - **Size**：例如 (150, 150)（背景圆圈大小）

### 步骤 3：创建 Handle（手柄圆圈）

1. 在 `JoystickPanel` 下，右键 → UI → Image，命名为 `Handle`
2. 设置 Image：
   - **Source Image**：可以留空，或者拖入一个圆形 Sprite
   - **Color**：不透明白色，例如 `(255, 255, 255, 255)`
3. 设置 RectTransform：
   - **Anchor Presets**：按住 Alt + Shift，点击 `Stretch-Stretch`
   - **Size**：例如 (60, 60)（手柄圆圈大小，应该比 Background 小）
   - **Anchored Position**：确保是 `(0, 0)`（初始在中心）

### 步骤 4：添加 EventSystem 支持（如果没有）

1. 在 `JoystickPanel` 上，右键 → UI → Event System（如果场景里还没有 EventSystem）
   - 或者确保 PersistentScene 里已经有 EventSystem（通常 Canvas 会自动创建）

---

## 三、设置 VirtualJoystick 组件

1. 选中 `JoystickPanel` 对象
2. 在 Inspector 中，点击 `Add Component`，搜索 `VirtualJoystick`，添加组件
3. 在 `VirtualJoystick` 组件中：
   - **Background**：拖入 `Background`（刚才创建的 Image）
   - **Handle**：拖入 `Handle`（刚才创建的 Image）
   - **Joystick Radius**：`50`（摇杆可移动范围，单位像素）
   - **Return To Center**：勾选（松开后自动回中）
   - **Return Speed**：`10`（回中速度）

---

## 四、设置 TouchInputHandler 组件

`TouchInputHandler` 负责把摇杆输入传给角色，它应该放在**常驻对象**上（例如 GameManager 或 UIManager 所在的 GameObject）。

### 步骤 1：找到或创建常驻对象

- 如果 `GameManager` 在 PersistentScene 里，可以在它上面添加 `TouchInputHandler`
- 或者创建一个新的空对象（例如 `InputManager`），放在 PersistentScene，并设置 `DontDestroyOnLoad`

### 步骤 2：添加 TouchInputHandler 组件

1. 选中常驻对象（例如 `GameManager`）
2. 在 Inspector 中，点击 `Add Component`，搜索 `TouchInputHandler`，添加组件
3. 在 `TouchInputHandler` 组件中：
   - **Virtual Joystick**：拖入 `JoystickPanel` 上的 `VirtualJoystick` 组件
   - **Character Controller**：可以留空（会自动查找场景中的角色）
   - **Dead Zone**：`0.1`（摇杆输入小于该值时视为无输入）

---

## 五、确保摇杆在移动端显示（可选）

如果你希望摇杆**只在移动端显示，PC 端隐藏**，可以在 `GameHudPanel` 或 `JoystickPanel` 上添加一个简单的脚本：

```csharp
using UnityEngine;

public class JoystickVisibility : MonoBehaviour
{
    private void Start()
    {
        // 只在移动端显示摇杆
        gameObject.SetActive(Application.isMobilePlatform);
    }
}
```

或者，如果你希望摇杆**始终显示**（编辑器也可以测试），可以不做任何处理。

---

## 六、验证设置

### 检查清单：

- [ ] `JoystickPanel` 下有 `Background` 和 `Handle` 两个 Image
- [ ] `JoystickPanel` 上挂载了 `VirtualJoystick` 组件，且 `Background` 和 `Handle` 引用已设置
- [ ] 常驻对象（如 `GameManager`）上挂载了 `TouchInputHandler` 组件，且 `Virtual Joystick` 引用已设置
- [ ] 场景中有 `EventSystem`（Canvas 通常会自动创建）
- [ ] 角色对象上挂载了 `CharacterController` 组件

### 测试步骤：

1. 运行游戏，进入 GameScene
2. 在 Game 窗口（或真机）上，用手指/鼠标拖动摇杆
3. 角色应该会朝拖拽方向移动
4. 松开后，摇杆手柄应该自动回到中心，角色停止移动

---

## 七、常见问题

### Q1: 摇杆拖不动 / 没有反应

- **检查**：`JoystickPanel` 上是否有 `GraphicRaycaster` 组件（Canvas 会自动添加，但有时需要手动添加）
- **检查**：`Background` 和 `Handle` 的 Image 组件是否启用（Inspector 左上角的勾选）
- **检查**：`EventSystem` 是否存在且启用

### Q2: 摇杆能拖动，但角色不动

- **检查**：`TouchInputHandler` 的 `Virtual Joystick` 引用是否正确
- **检查**：Console 是否有报错（例如找不到 `CharacterController`）
- **检查**：角色对象上是否有 `CharacterController` 组件

### Q3: 摇杆在编辑器里看不到

- **检查**：`JoystickPanel` 的 `RectTransform` 位置是否在屏幕可见范围内
- **检查**：`Background` 和 `Handle` 的 `Color` 是否设置了 Alpha > 0（如果 Alpha = 0 会完全透明）

### Q4: 摇杆在移动端不显示

- **检查**：是否有脚本在控制 `JoystickPanel` 的 `SetActive(false)`
- **检查**：`JoystickPanel` 是否在正确的 Canvas 下（应该在 PersistentScene 的 Canvas）

---

## 八、快速设置模板（如果不想手动创建）

如果你希望我帮你写一个编辑器工具，可以：
1. 自动在 Canvas 下创建 `JoystickPanel` + `Background` + `Handle`
2. 自动添加 `VirtualJoystick` 组件并设置引用
3. 自动在 `GameManager` 上添加 `TouchInputHandler` 并设置引用

告诉我是否需要这个工具。
