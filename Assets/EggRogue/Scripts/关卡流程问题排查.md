# 关卡流程问题排查指南

## 问题：胜利后没有弹出结算界面，也没有进入下一关

### 排查步骤

#### 1. 检查 Console 日志

运行游戏，等待胜利后，查看 Console 是否有以下日志：

**应该看到的日志顺序：**
```
LevelTimer: 关卡胜利！剩余时间: 0.0秒，准备触发 OnLevelVictory 事件
LevelTimer: OnLevelVictory 事件已触发，监听器数量: X
LevelFlowManager: OnLevelVictory() 被调用 - 关卡胜利
LevelFlowManager: 拾取金币 = X - Y = Z
LevelFlowManager: 胜利奖励 = X (来自 LevelData)
LevelFlowManager: 调用 UIManager.ShowResult(X, Y)
UIManager: ShowResult(X, Y) 被调用
ResultPanel: ShowResult(X, Y) 被调用
ResultPanel: 显示结算界面
```

**如果没有看到这些日志，说明问题在：**

- **没有看到 "LevelTimer: 关卡胜利"**
  - 问题：LevelTimer 没有触发胜利
  - 检查：
    1. GameScene 中是否有 **LevelTimer** 对象？
    2. LevelTimer 组件是否勾选了 **Auto Start**？
    3. 玩家是否有 **Health** 组件？
    4. 玩家是否在时间到之前死亡了？

- **没有看到 "LevelFlowManager: OnLevelVictory"**
  - 问题：LevelFlowManager 没有监听到事件
  - 检查：
    1. GameScene 中是否有 **LevelFlowManager** 对象？
    2. LevelFlowManager 的 **Level Timer** 字段是否绑定了 LevelTimer（或留空让它自动查找）？
    3. 检查 Console 是否有 "LevelFlowManager: Start() 被调用" 的日志

- **没有看到 "UIManager: ShowResult"**
  - 问题：UIManager.Instance 为空
  - 检查：
    1. PersistentScene 中是否有 **UIManager** 对象？
    2. UIManager 是否在 **Managers** 下？
    3. UIManager 是否设置了 **DontDestroyOnLoad**？

- **没有看到 "ResultPanel: ShowResult"**
  - 问题：ResultPanel 未设置
  - 检查：
    1. PersistentScene 的 Canvas 下是否有 **ResultPanel**？
    2. UIManager 的 **Result Panel** 字段是否绑定了 ResultPanel？

---

#### 2. 检查 GameScene 设置

1. **打开 GameScene**
2. **检查是否有 LevelTimer 对象：**
   - 如果没有，创建空物体，命名为 `LevelTimer`
   - 添加 **LevelTimer** 组件
   - 勾选 **Auto Start**

3. **检查是否有 LevelFlowManager 对象：**
   - 如果没有，创建空物体，命名为 `LevelFlowManager`
   - 添加 **LevelFlowManager** 组件
   - 将 **LevelTimer** 对象拖到 **Level Timer** 字段（或留空，会自动查找）

---

#### 3. 检查 PersistentScene 设置

1. **打开 PersistentScene**
2. **检查 UIManager：**
   - 在 **Managers** 下应该有 **UIManager** 对象
   - 选中 UIManager，在 Inspector 中检查：
     - **Result Panel** 字段是否绑定了 ResultPanel？
     - **Card Selection Panel** 字段是否绑定了 CardSelectionPanel？

3. **检查 ResultPanel：**
   - 在 **UIRoot/Canvas** 下应该有 **ResultPanel**（Panel）
   - 确认 ResultPanel 组件已添加
   - 确认 ResultPanel 默认是**隐藏**的（GameObject 未激活）

---

#### 4. 检查玩家设置

1. **玩家对象是否有 Health 组件？**
   - 如果没有，添加 **Health** 组件
   - 设置 **Max Health**（例如：100）

2. **玩家是否有 CharacterController 组件？**
   - 如果没有，添加 **CharacterController** 组件

---

#### 5. 检查 LevelData 配置

1. **打开 `Assets/EggRogue/Configs/Levels/Level_01.asset`**
2. **检查字段：**
   - **Level Duration** 应该 > 0（例如：30）
   - **Victory Reward Gold** 应该 >= 0（例如：50）

---

#### 6. 快速测试方法

如果以上都检查过了，可以手动测试：

1. **在 GameScene 中选中 LevelTimer**
2. **在 Inspector 中点击 OnLevelVictory 事件的 "+" 按钮**
3. **添加一个测试对象，调用一个方法（例如：打印日志）**
4. **运行游戏，等待胜利**
5. **如果测试方法被调用，说明 LevelTimer 正常，问题在 LevelFlowManager 或 UIManager**

---

## 常见问题解决方案

### 问题 1：LevelTimer 找不到玩家

**症状：** Console 显示 "LevelTimer: 未找到玩家 Health 组件"

**解决：**
1. 确保玩家对象有 **Health** 组件
2. 或者给玩家对象添加 **Tag: Player**

### 问题 2：LevelFlowManager 找不到 LevelTimer

**症状：** Console 显示 "LevelFlowManager: 未找到 LevelTimer"

**解决：**
1. 确保 GameScene 中有 LevelTimer 对象
2. 在 LevelFlowManager 的 Inspector 中，手动将 LevelTimer 拖到 **Level Timer** 字段

### 问题 3：ResultPanel 不显示

**症状：** Console 显示 "ResultPanel: ShowResult 被调用" 但界面不显示

**解决：**
1. 检查 ResultPanel 的 GameObject 是否激活
2. 检查 ResultPanel 的 Canvas Group 是否设置了 Alpha = 0 或 Interactable = false
3. 检查 ResultPanel 的 RectTransform 位置是否在屏幕外

### 问题 4：卡片选择界面不显示

**症状：** 结算界面 2 秒后没有进入卡片选择

**解决：**
1. 检查 CardSelectionPanel 是否存在
2. 检查 CardSelectionPanel 的 **Card Database** 是否已设置
3. 检查 Console 是否有 "CardSelectionPanel: cardDatabase 未设置" 的警告

---

## 调试命令

在 Unity Console 中，可以输入以下命令来检查状态：

```csharp
// 检查 LevelTimer 状态
FindObjectOfType<LevelTimer>()?.RemainingTime

// 检查 LevelFlowManager 是否存在
FindObjectOfType<LevelFlowManager>() != null

// 检查 UIManager 状态
UIManager.Instance?.GetCurrentPanelName()

// 检查 ResultPanel 是否可见
FindObjectOfType<ResultPanel>()?.IsVisible()
```

---

完成以上检查后，应该能定位到问题所在。如果还有问题，请提供 Console 的完整日志。
