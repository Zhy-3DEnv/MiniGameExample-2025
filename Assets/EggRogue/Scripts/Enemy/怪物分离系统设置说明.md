# 怪物分离系统设置说明

## 问题背景

当同屏有大量怪物（例如2000个）时，怪物会重叠在一起，影响游戏体验和性能。

## 解决方案

使用 **`EnemySeparation`** 组件，通过简单的排斥力让怪物互相推开，避免重叠。

### 性能优化策略

1. **不使用物理碰撞**：避免2000个怪物使用 Rigidbody + Collider 造成的性能问题
2. **空间分区优化**：只检测附近怪物（`detectionRadius`），不检测所有怪物
3. **分帧处理**：每帧只处理一部分怪物（`maxEnemiesPerFrame`），避免单帧卡顿
4. **降低更新频率**：不是每帧更新，而是按间隔更新（`updateInterval`）

---

## 设置步骤

### 步骤1：添加 EnemySeparation 组件

1. 在 GameScene 中，找到 **EnemyManager** 对象
2. 添加组件：`Enemy Separation`
3. 在 Inspector 中配置参数：
   - `Separation Force`: **5**（排斥力强度，可以调整）
   - `Detection Radius`: **2**（检测范围，只检测这个范围内的其他怪物）
   - `Min Separation Distance`: **0.5**（最小分离距离）
   - `Update Interval`: **0.1**（更新间隔，每0.1秒更新一次）
   - `Max Enemies Per Frame`: **50**（每帧最多处理的怪物数量）

### 步骤2：调整参数（根据实际效果）

**如果怪物还是重叠：**
- 增加 `Separation Force`（例如改为 8 或 10）
- 减小 `Min Separation Distance`（例如改为 0.3）

**如果性能有问题：**
- 增加 `Update Interval`（例如改为 0.2，降低更新频率）
- 减小 `Max Enemies Per Frame`（例如改为 30）
- 减小 `Detection Radius`（例如改为 1.5，减少检测范围）

**如果怪物分离太明显（看起来不自然）：**
- 减小 `Separation Force`（例如改为 3）
- 增加 `Min Separation Distance`（例如改为 0.8）

---

## 工作原理

1. **分帧处理**：
   - 系统每 `updateInterval` 秒更新一次
   - 每次更新只处理 `maxEnemiesPerFrame` 个怪物
   - 通过轮询方式，确保所有怪物都会被处理

2. **空间优化**：
   - 每个怪物只检测 `detectionRadius` 范围内的其他怪物
   - 避免检测所有2000个怪物，大幅提升性能

3. **排斥力计算**：
   - 对于每个附近的怪物，计算分离方向（从其他怪物指向当前怪物）
   - 距离越近，排斥力越大
   - 如果距离小于 `minSeparationDistance`，加倍排斥力

4. **平滑移动**：
   - 分离力是一个"微调"，不会完全覆盖怪物的寻路逻辑
   - 怪物仍然会朝玩家移动，但会稍微避开其他怪物

---

## 性能说明

### 理论性能

假设有 2000 个怪物：

- **不使用优化**：每帧检测 2000 × 2000 = 4,000,000 次（不可行）
- **使用空间优化**：每个怪物平均检测 10 个邻居 = 20,000 次检测
- **使用分帧处理**：每帧只处理 50 个怪物 = 500 次检测
- **使用更新间隔**：每 0.1 秒更新一次 = 每帧约 50 次检测

**最终性能**：每帧约 50 次距离计算，性能开销很小。

### 进一步优化（如果还有性能问题）

1. **使用 Unity Job System**：
   - 将分离计算放到多线程中
   - 适合超大量怪物（5000+）

2. **使用空间分区（Grid/QuadTree）**：
   - 将场景分成网格，只检测同一网格的怪物
   - 进一步减少检测次数

3. **LOD 系统**：
   - 距离玩家远的怪物使用更简单的分离逻辑
   - 距离玩家近的怪物使用完整分离逻辑

---

## 常见问题

### Q: 怪物还是会重叠？
A: 
- 检查 `Separation Force` 是否足够大
- 检查 `Detection Radius` 是否足够大（应该覆盖怪物的碰撞范围）
- 检查 `Update Interval` 是否太小（更新太慢可能导致重叠）

### Q: 性能还是有问题？
A:
- 增加 `Update Interval`（降低更新频率）
- 减小 `Max Enemies Per Frame`（每帧处理更少怪物）
- 减小 `Detection Radius`（减少检测范围）

### Q: 怪物分离太明显，看起来不自然？
A:
- 减小 `Separation Force`
- 增加 `Min Separation Distance`（允许怪物更靠近）

### Q: 怪物无法正常朝玩家移动？
A:
- 分离力应该是一个"微调"，不应该完全覆盖寻路
- 如果问题严重，减小 `Separation Force`

---

## 后续扩展

如果需要更高级的功能：

1. **不同怪物类型有不同的分离距离**：
   - 在 `EnemyController` 中添加 `separationRadius` 字段
   - `EnemySeparation` 读取这个值，而不是使用全局值

2. **怪物大小影响分离**：
   - 大怪物需要更大的分离距离
   - 小怪物可以更靠近

3. **玩家附近的怪物分离更明显**：
   - 距离玩家越近，分离力越大
   - 避免玩家被怪物包围

---

完成设置后，怪物应该不会再重叠，同时保持良好的性能！
