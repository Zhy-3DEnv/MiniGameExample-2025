# 微信小游戏打包测试指南

## 一、打包前准备

### 步骤1：确认 CSV 文件已放入 StreamingAssets

1. 确认文件位置：`Assets/EggRogue/StreamingAssets/gameconfig.csv`
2. 确认文件内容正确（可以在 Unity 中打开查看）

### 步骤2：检查 CSVConfigManager 设置

1. 在 **GameScene** 中，找到 `CSVConfigManager` 对象
2. 检查配置：
   - `CSV File Name`: **gameconfig.csv**
   - `Allow Local File Read`: **取消勾选**（打包后不需要本地文件）
   - `Local File Path`: **留空**

### 步骤3：确认更新配置按钮

1. 在 **GameHudPanel** 下应该有"更新配置"按钮
2. 按钮已挂载 `Config Update Button` 组件

---

## 二、打包流程

### 步骤1：使用微信小游戏构建工具

1. 在 Unity 菜单：**微信小游戏 > 转换小游戏**
2. 或使用已有的构建配置（参考 FlappyBird 的配置）

### 步骤2：确认 StreamingAssets 被打包

1. 打包后，检查构建输出目录
2. 应该能看到 `StreamingAssets` 文件夹
3. 确认 `gameconfig.csv` 在 `StreamingAssets` 目录中

---

## 三、测试步骤

### 步骤1：上传到微信开发者工具

1. 将构建输出目录上传到微信开发者工具
2. 在微信开发者工具中运行

### 步骤2：测试 CSV 读取

1. **启动游戏**：
   - 进入 GameScene
   - 查看 Console 日志
   - 应该看到：`CSVConfigManager: 已加载 X 个配置项`

2. **测试更新配置**：
   - 修改 Excel 文件，另存为 CSV
   - 将 CSV 复制到构建输出目录的 `StreamingAssets` 文件夹
   - 在微信开发者工具中点击"编译"（重新加载资源）
   - 或点击游戏中的"更新配置"按钮
   - 查看配置是否生效

---

## 四、WebGL 环境下的 CSV 读取

### 当前实现

`CSVConfigManager` 已支持 WebGL 环境：
- **编辑器/PC/Mac**：直接使用 `File.ReadAllText`
- **WebGL/微信小游戏**：自动使用 `UnityWebRequest` 异步读取

### 工作原理

1. **编辑器模式**：从 `Assets/EggRogue/StreamingAssets/` 直接读取
2. **WebGL 运行时**：
   - 先尝试 `File.ReadAllText`（某些 WebGL 构建可能支持）
   - 如果不支持，使用 `UnityWebRequest` 异步加载
   - 通过协程 `LoadConfigAsync()` 实现

### 注意事项

- WebGL 环境下，StreamingAssets 路径可能指向 CDN 或本地缓存
- 确保 CSV 文件被打包进 StreamingAssets 目录
- 如果读取失败，检查 Console 日志查看具体错误

---

## 五、调试技巧

### 查看日志

1. **Unity Console**（编辑器）
2. **微信开发者工具 Console**（打包后）
3. **浏览器 Console**（如果使用 WebGL 测试）

### 常见日志

- ✅ `CSVConfigManager: 已加载 X 个配置项` - 成功读取
- ⚠️ `CSVConfigManager: 无法读取 CSV 文件，使用默认配置` - 文件未找到
- ⚠️ `CSVConfigManager: StreamingAssets 文件不存在: xxx` - 路径错误

### 检查文件路径

在代码中添加日志输出实际尝试的路径：
```csharp
Debug.Log($"CSVConfigManager: 尝试路径: {streamingPath}");
Debug.Log($"CSVConfigManager: Application.streamingAssetsPath = {Application.streamingAssetsPath}");
```

---

## 六、微信小游戏特殊注意事项

1. **文件路径**：
   - 微信小游戏中，`Application.streamingAssetsPath` 可能指向 CDN 或本地缓存
   - 确保 CSV 文件被打包进 StreamingAssets

2. **文件更新**：
   - 修改 CSV 后，需要重新打包或重新上传 StreamingAssets
   - 或使用"更新配置"按钮从服务器/CDN 重新加载

3. **性能**：
   - CSV 文件很小，读取性能不是问题
   - 如果文件很大，考虑使用异步加载

---

## 七、测试 checklist

- [ ] CSV 文件在 `Assets/EggRogue/StreamingAssets/gameconfig.csv`
- [ ] 打包后 StreamingAssets 文件夹存在
- [ ] 打包后 gameconfig.csv 在 StreamingAssets 中
- [ ] 游戏启动时 Console 显示"已加载 X 个配置项"
- [ ] 修改 CSV 后，点击"更新配置"按钮能重新读取
- [ ] 配置值正确应用到游戏对象（玩家伤害、怪物血量等）

---

完成以上步骤后，你应该能在微信小游戏中正常使用 CSV 配置系统了！
